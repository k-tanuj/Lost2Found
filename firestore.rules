rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ðŸ”’ Default: Deny all access
    match /{document=**} {
      allow read, write: if false;
    }

    // ðŸ”” Notifications:
    // - Users can ONLY read their OWN notifications
    // - Users can ONLY mark their own notifications as 'read' (no other field changes)
    // - All creates/deletes must go through Backend API (Admin SDK)
    match /notifications/{notificationId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      
      // Allow users to mark their own notifications as read ONLY
      allow update: if request.auth != null 
                    && resource.data.userId == request.auth.uid
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read'])
                    && request.resource.data.read == true;
      
      allow create, delete: if false; // Backend only
    }
    
    // ðŸ“¦ Items:
    // - ALL operations (read/write) go through the Backend API
    // - Direct Firestore access is BLOCKED to prevent scraping, bypass, or data corruption
    match /items/{itemId} {
      allow read, write: if false;
    }
  }
}
